#include <cstring>
#include <gtest/gtest.h>

#include "tinycrc32.h"

class CRC32Test : public testing::Test {
public:
  /* foreach row of a 256x256 matrix the crc value is computed and compared with
   * the respective value below; the matrix is defined to be m_{i, j} = j > i ?
   * 0 : (j - 1) */
  const uint32_t expected_result[256] = {
      4294967295, 2911022254, 4243917614, 1828893701, 650962268,  3688517369,
      3203824363, 1554387635, 1976779716, 2394634839, 4258520782, 82469381,
      2893829445, 962968101,  2858267563, 2534472713, 641136404,  3351028200,
      2333804568, 1802056496, 864424985,  3206269639, 844597910,  2193911026,
      3594745962, 2423613314, 196158027,  2739267826, 2602645054, 3239960351,
      3791285544, 379802676,  3106047665, 1618632082, 2703620960, 2699118768,
      2170089131, 3697565618, 1186921635, 3074527640, 3971026812, 2522086595,
      2286212062, 880590009,  1940385884, 1911288829, 3550612056, 1474957807,
      3285896405, 3590481610, 1781646888, 2077679249, 1124799375, 736088801,
      342010214,  1362212986, 4261568727, 3185415774, 3048286751, 368651240,
      3231116148, 3412251544, 2540815209, 2239287291, 76728596,   2528894725,
      2255958396, 2619179431, 607527556,  3282637030, 2983784258, 3341504496,
      1712864621, 355107583,  2493628323, 2601964137, 3239962875, 1713245130,
      1448755608, 4112800770, 4272321843, 1919469283, 1398565624, 3388654068,
      1984441228, 1501360463, 2078643110, 4078275302, 1083040832, 2596737604,
      2951498926, 878384166,  3464774602, 3032981436, 300936326,  1494963848,
      121675286,  1463743355, 2079052196, 3847695101, 1043665946, 3722370622,
      3362893622, 1374530428, 2307293695, 1189813885, 3615669102, 3343717796,
      2639878133, 3934748300, 296856679,  2023975520, 1584111438, 2630196489,
      4225616223, 2674794436, 1715501117, 967804424,  3465131864, 2349578318,
      1222482373, 225829763,  2558603950, 349304710,  1280504401, 2681835775,
      1666355743, 2479768307, 3475389162, 183213408,  290570372,  649115176,
      1004842539, 4234374444, 3657764103, 1883749750, 24488907,   1378524131,
      175542721,  3640180758, 760760324,  134364159,  2427135681, 536382142,
      3264688696, 676362843,  2823249542, 3614185262, 233460237,  3927428489,
      1576476530, 620218394,  1039827043, 1792687822, 2240111622, 3748574883,
      3135602632, 2516953267, 2354263121, 2635221460, 3631195342, 3446031329,
      1102478335, 3997966459, 1508177220, 3815329007, 712662216,  3449050649,
      513825208,  272656182,  3433791572, 1608154066, 158684602,  922113490,
      800956028,  851913922,  3738966173, 2672500245, 1699637671, 634035482,
      3671893239, 1391538924, 700837933,  185111260,  4165218507, 1647371209,
      1912235246, 2530129832, 60357164,   2460706029, 1370976695, 2028170429,
      3779302299, 3360502395, 3644790723, 4071799828, 132855804,  3124623945,
      3473918290, 1442669761, 653531788,  2261221049, 1897829235, 3403069334,
      4006035639, 3909040246, 729032394,  3350324025, 3574086014, 249955000,
      427470508,  3724120452, 2234664873, 3459590809, 217507654,  2460224240,
      4108668479, 923675071,  1196456611, 158195643,  1641021117, 2479677343,
      2698224020, 708437541,  2561048235, 3630829817, 2589980080, 2961503697,
      3513302451, 2235487877, 1631825332, 2961172873, 3440268204, 2251064560,
      1751789607, 2093809703, 2394039316, 2033812894, 1655807612, 1945189758,
      1622183465, 2869005033, 2586615338, 1502647802, 2028686169, 488313406,
      1511626477, 2307749314, 94097624,   548934926,  663008139,  2211730365,
      1733897735, 1786813792, 770322521,  1990998909,
  };
};

TEST_F(CRC32Test, main_test) {
  uint8_t *data = new uint8_t[256];
  std::memset(data, 0, 256);

  for (uint8_t i = 0; i <= 254; ++i) {
    data[i] = i;
    EXPECT_EQ(crc32c(data, i), expected_result[i]);
  }

  data[255] = 255;
  EXPECT_EQ(crc32c(data, 255), expected_result[255]);

  delete[] data;
}

int main(int argc, char **argv) {
  testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
